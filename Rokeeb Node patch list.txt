1. Create missing idempotency middleware

src/middleware/idempotency.ts
Implement Mongo TTL + unique index.

2. Replace verifySignature.ts with full HMAC + timestamp + replay guards

Must include:

X-Timestamp

60s drift window

SHA256 HMAC

Raw body validation

Reject unsigned payloads

3. Create missing controllers

webhookController.ts

otpController.ts

payController.ts

Move all handler logic out of routes.

4. Implement API routes

src/routes/otp.ts

src/routes/pay.ts

/flow/*

/user/*

/auth/*

5. Implement db abstraction

Create:

src/services/db.ts
with:

Connection pooling

Retry logic

Graceful reconnect

Health check

6. Implement Queue backend

Add Redis + BullMQ:

src/queue/worker.ts
src/queue/processor.ts

7. Implement worker engines

src/workers/* should include:

OCR processor

Flow executor

Messaging retry

Refund executor

Daily cleanup

Currently missing.

8. Add PM2 config

pm2.config.js

9. Add Dockerfile

Full production image.

10. Add DB migrations

TTL indexes

Unique indexes

Schema validation

11. Move templates out of code

Use DB or filesystem template registry.

12. Add missing logs

Full audit trail for:

failed signatures

blocked IPs

failed messaging

refund actions

13. Add OpenAPI spec

Document:

/webhook/entry

/otp/*

/msg/*

/pay/*

/flow/*

/user/*